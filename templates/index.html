<!doctype html>
<html>
  <head>
    <title>Chat with the Scriptures</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='main.css') }}"
    />
  </head>
  <body>
    <div class="header">

  <header>Scripture AI chatbot--the scriptures cited should be authentic, but you may want to take any interpretations with a grain of salt.</header>
    </div>
    <div class="chat-container">
        <div class="message-role assistant">Scripture Helper</div>
        <div class="assistant-message">Ask me any question about the scriptures!<br>You can ask:<br>"What does it mean to have faith?"<br>"Who was Jonah?"<br>"Show me Alma 32:1-3"</div>
      {% for message in chat_history %}
      <div class="message-role {{ 'user' if message.role == 'user' else 'assistant' }}">
        {{ message.role.capitalize() if message.role == 'user' else 'Scripture Helper' }}
      </div>
      <div
        class="{{ 'user-message' if message.role == 'user' else 'assistant-message' }}"
      >
        {{ message.content }}
      </div>
      {% endfor %}
    </div>
    <div class="message-input-container">
      <form action="/chat" id="chat-form" method="post">
        <textarea
          name="message"
          id="message-input"
          placeholder="Enter a Scripture Question..."
        ></textarea>
        <div class="button-group">
          <button type="submit" id="send-btn">&#x2191;</button>
        </div>
      </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const messageInput = document.querySelector('textarea[name="message"]');
    const chatContainer = document.querySelector(".chat-container");

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Handle form submission
    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const message = messageInput.value.trim();
        if (message) {
            // Append the user's message to the chat container
            const userRoleDiv = document.createElement("div");
            userRoleDiv.classList.add("message-role", "user");
            userRoleDiv.textContent = "User";
            chatContainer.appendChild(userRoleDiv);

            const userMessageDiv = document.createElement("div");
            userMessageDiv.classList.add("user-message");
            userMessageDiv.textContent = message;
            chatContainer.appendChild(userMessageDiv);

            // Clear the message input
            messageInput.value = "";

            // Scroll to the bottom of the chat container
            scrollToBottom();

            // Send the user's message to the server using AJAX
            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const assistantRoleDiv = document.createElement("div");
                    assistantRoleDiv.classList.add("message-role", "assistant");
                    assistantRoleDiv.textContent = "Scripture Helper";
                    chatContainer.appendChild(assistantRoleDiv);

                    // Prepare the assistant's message container
                    const assistantMessageDiv = document.createElement("div");
                    assistantMessageDiv.classList.add("assistant-message");
                    chatContainer.appendChild(assistantMessageDiv);

                    // Open a connection to receive streamed responses
                    const eventSource = new EventSource("/stream");
                    eventSource.onmessage = function(event) {
                        const currentText = assistantMessageDiv.innerHTML;
                        const newText = event.data;
                        const lastChar = currentText.slice(-1);

                        // Check if we need to add a space (streamed chunks might be missing it)
                        if (/[.,!?]/.test(lastChar) && newText.charAt(0) !== " ") {
                            assistantMessageDiv.innerHTML += " " + newText;
                        } else {
                            assistantMessageDiv.innerHTML += newText;
                        }

                        // Scroll to the bottom of the chat container
                        scrollToBottom();
                    };
                    eventSource.onerror = function() {
                        eventSource.close();
                    };
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }
    });

    // Handle Enter key press in the textarea
    messageInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) { // Check if Enter is pressed without Shift
            event.preventDefault(); // Prevent the default newline behavior
            form.requestSubmit(); // Trigger form submission
        }
    });

    // Add event listener for the clear button
    document.getElementById("clear-btn").addEventListener("click", function() {
        // Clear the chat container
        chatContainer.innerHTML = "";

        // Re-insert the initial system message as an assistant message
        const systemMessageDiv = document.createElement("div");
        systemMessageDiv.classList.add("assistant-message"); // Use the assistant message class
        systemMessageDiv.textContent = "You are a helpful assistant.";
        chatContainer.appendChild(systemMessageDiv);

        // Reset the chat history on the server
        fetch("/reset", {
            method: "POST",
        }).then(response => {
            if (response.ok) {
                console.log("Chat history has been reset.");
            }
        });
    });
});document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const messageInput = document.querySelector('textarea[name="message"]');
    const chatContainer = document.querySelector(".chat-container");

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Handle form submission
    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const message = messageInput.value.trim();
        if (message) {
            // Append the user's message to the chat container
            const userRoleDiv = document.createElement("div");
            userRoleDiv.classList.add("message-role", "user");
            userRoleDiv.textContent = "User";
            chatContainer.appendChild(userRoleDiv);

            const userMessageDiv = document.createElement("div");
            userMessageDiv.classList.add("user-message");
            userMessageDiv.textContent = message;
            chatContainer.appendChild(userMessageDiv);

            // Clear the message input
            messageInput.value = "";

            // Scroll to the bottom of the chat container
            scrollToBottom();

            // Send the user's message to the server using AJAX
            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const assistantRoleDiv = document.createElement("div");
                    assistantRoleDiv.classList.add("message-role", "assistant");
                    assistantRoleDiv.textContent = "Scripture Helper";
                    chatContainer.appendChild(assistantRoleDiv);

                    // Prepare the assistant's message container
                    const assistantMessageDiv = document.createElement("div");
                    assistantMessageDiv.classList.add("assistant-message");
                    chatContainer.appendChild(assistantMessageDiv);

                    // Open a connection to receive streamed responses
                    const eventSource = new EventSource("/stream");
                    eventSource.onmessage = function(event) {
                        const currentText = assistantMessageDiv.innerHTML;
                        const newText = event.data;
                        const lastChar = currentText.slice(-1);

                        // Check if we need to add a space (streamed chunks might be missing it)
                        if (/[.,!?]/.test(lastChar) && newText.charAt(0) !== " ") {
                            assistantMessageDiv.innerHTML += " " + newText;
                        } else {
                            assistantMessageDiv.innerHTML += newText;
                        }

                        // Scroll to the bottom of the chat container
                        scrollToBottom();
                    };
                    eventSource.onerror = function() {
                        eventSource.close();
                    };
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }
    });

    // Handle Enter key press in the textarea
    messageInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) { // Check if Enter is pressed without Shift
            event.preventDefault(); // Prevent the default newline behavior
            form.requestSubmit(); // Trigger form submission
        }
    });

    // Add event listener for the clear button
    document.getElementById("clear-btn").addEventListener("click", function() {
        // Clear the chat container
        chatContainer.innerHTML = "";

        // Re-insert the initial system message as an assistant message
        const systemMessageDiv = document.createElement("div");
        systemMessageDiv.classList.add("assistant-message"); // Use the assistant message class
        systemMessageDiv.textContent = "You are a helpful assistant.";
        chatContainer.appendChild(systemMessageDiv);

        // Reset the chat history on the server
        fetch("/reset", {
            method: "POST",
        }).then(response => {
            if (response.ok) {
                console.log("Chat history has been reset.");
            }
        });
    });
});
    </script>
  </body>
</html>
